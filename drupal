#!/usr/bin/env ruby

require 'rubygems'
require 'bundler/setup'
require 'commander/import'
require 'fileutils'

program :version, '0.1'
program :description, 'Setup an initial drupal setup'

command :setup do |c|
  c.syntax = 'drupal setup <project_name> [options]'
  c.description = 'Creates and installs a new Drupal project.'
  c.example 'Create a project called Superapp.', 'drupal setup "Superapp"'
  c.option '--makefile FILE', String, 'Path to drush makefile'
  c.option '--gitignore FILE', String, 'Path to .gitignore file'
  c.option '--install_profile NAME', String, 'The name of the install profile to use. Must be in profiles directory'
  c.option '--db_name NAME', String, 'Database name'
  c.action do |args, options|
    if args[0].nil?
      puts "Please specify a project name."
    else
      # Setup constants.
      PROJECT_NAME = sanitize_filename args[0]
      SOURCE_PATH = File.expand_path(File.dirname(__FILE__))

      # Setup optional flags.
      options.default \
        :makefile => "#{ SOURCE_PATH }/d7.make",
        :gitignore  => "#{ SOURCE_PATH }/gitignore.txt",
        :install_profile  => "quilted_profile",
        :db_name => PROJECT_NAME

      # Ask for key inputs.
      db_user = ask "> Database user:"
      db_password = password "> Database password:"
      drupal_email = ask "> Drupal email:"

      # Go through the process.
      create_file_structure
      create_drushrc
      create_gitignore options.gitignore
      download_drupal options.makefile
      create_drushrc_symlink
      copy_features
      copy_install_profile
      copy_subtheme
      install_drupal options.install_profile, db_user, db_password, drupal_email
      create_general_feature
      setup_git
    end
  end
end

def sanitize_filename(filename)
  return filename.strip do |name|
    # NOTE: File.basename doesn't work right with Windows paths on Unix
    # get only the filename, not the whole path
    name.gsub! /^.*(\\|\/)/, ''

    # Finally, replace all non alphanumeric, underscore or periods with underscore
    # name.gsub! /[^\w\.\-]/, '_'
    # Basically strip out the non-ascii alphabets too and replace with x. You don't want all _ :)
    name.gsub!(/[^0-9A-Za-z.\-]/, 'x')
  end
end

def create_file_structure
  puts 'Setting up file structure...'
  FileUtils.mkdir_p "#{ PROJECT_NAME }/databases"
  FileUtils.mkdir_p "#{ PROJECT_NAME }/private_files"
  FileUtils.touch "#{ PROJECT_NAME }/private_files/PLACEHOLDER.txt"
  FileUtils.mkdir_p "#{ PROJECT_NAME }/tmp_files"
  FileUtils.touch "#{ PROJECT_NAME }/tmp_files/PLACEHOLDER.txt"
end

def create_drushrc
  puts "Setting up drushrc.php..."
  FileUtils.cp "#{ SOURCE_PATH }/dgb/example-dgb.drushrc.php", "#{ PROJECT_NAME }/drushrc.php"
end

def download_drupal(makefile)
  puts "Download Drupal and modules..."
  system %{ drush make --prepare-install #{ makefile } #{ PROJECT_NAME }/www }
end

def create_gitignore(gitignore)
  puts "Setting up .gitignore..."
  puts gitignore
  FileUtils.cp "#{ gitignore }", "#{ PROJECT_NAME }/.gitignore"
end

def create_drushrc_symlink
  puts "Create drushrc.php symlink..."
  File.symlink("../drushrc.php", "#{ PROJECT_NAME }/www/drushrc.php")
end

def copy_install_profile
  puts  "Copy install profile..."
  FileUtils.cp_r "#{ SOURCE_PATH }/profiles/quilted_profile", "#{ PROJECT_NAME }/www/profiles/quilted_profile"
end

def copy_features
  puts  "Copy dev and prod features..."
  path = "#{ PROJECT_NAME }/www/sites/all/modules/custom"
  FileUtils.mkdir_p path
  FileUtils.cp_r "#{ SOURCE_PATH }/modules/.", "#{ path }"
end

def copy_subtheme
  puts "Create Omega subtheme..."
  FileUtils.cp_r "#{ SOURCE_PATH }/themes/.", "#{ PROJECT_NAME }/www/sites/all/themes"
  replace_prefix "#{ PROJECT_NAME }/www/sites/all/themes"
end

def replace_prefix(path)
  Dir.glob(path + '/*') do |filename|
    next if filename == '.' or filename == '..'

    if File.directory? filename
      replace_prefix filename
    end

    if File.file? filename
      text = File.read(filename)
      replace = text.gsub(/quilted/, PROJECT_NAME)
      File.open(filename, "w") {|file| file.puts replace}
    end

    if File.basename(filename) =~ /quilted/
      new_name = File.basename(filename).gsub(/quilted/, PROJECT_NAME)
      newpath = File.join(path, new_name)
      File.rename(filename, newpath)
    end
  end
end

def install_drupal(install_profile, db_user, db_password, drupal_email)
  puts "Install Drupal..."
  si_command = "drush si #{ install_profile } --site-name=#{ PROJECT_NAME } --site-mail=#{ drupal_email } --account-name=admin --account-pass=admin --account-mail=#{ drupal_email } --db-url=mysql://#{ db_user }:#{ db_password }@localhost:/#{ PROJECT_NAME } -y"

  FileUtils.cd "#{ PROJECT_NAME }/www"
  system %{ #{ si_command } }
  FileUtils.cd "../.."
end

def create_general_feature
  puts "Create general feature..."
  components = [
    # Variables
    'variable:admin_theme',
    'variable:clean_url',
    'variable:date_api_version',
    'variable:date_default_timezone',
    'variable:date_first_day',
    'variable:date_format_long',
    'variable:date_format_medium',
    'variable:date_format_short',
    'variable:delta_blocks_branding_logo_linked',
    'variable:delta_blocks_branding_logo_render',
    'variable:delta_blocks_branding_site_name_hidden',
    'variable:delta_blocks_branding_site_name_linked',
    'variable:delta_blocks_branding_site_slogan_hidden',
    'variable:delta_blocks_breadcrumb_current',
    'variable:delta_blocks_breadcrumb_title_hidden',
    'variable:delta_blocks_logo_linked',
    'variable:delta_blocks_page_title_hidden',
    'variable:delta_blocks_site_name_hidden',
    'variable:delta_blocks_site_name_linked',
    'variable:delta_blocks_site_slogan_hidden',
    'variable:features_ignored_orphans',
    'variable:file_private_path',
    'variable:file_temporary_path',
    'variable:node_admin_theme',
    'variable:node_options_page',
    'variable:node_submitted_page',
    'variable:path_alias_whitelist',
    'variable:pathauto_blog_pattern',
    'variable:pathauto_node_pattern',
    'variable:pathauto_punctuation_hyphen',
    'variable:pathauto_taxonomy_term_pattern',
    'variable:pathauto_user_pattern',
    'variable:site_404',
    'variable:site_default_country',
    'variable:site_mail',
    'variable:site_name',
    'variable:theme_default',
    'variable:user_admin_role',
    'variable:user_register',
    'variable:xmlsitemap_generated_last',
    'variable:xmlsitemap_regenerate_needed',

    # Fields
    'field:node-page-body',
    'field:node-page-field_tags',

    # Filters
    'filter:full_html_no_filters',
    'filter:filtered_html',
    'filter:full_html',
    'filter:plain_text',
    'filter:ds_code',

    # Image
    'image:thumbnail',
    'image:medium',
    'image:large',
    'image:square_thumbnail',

    # Node
    'node:page',

    # Taxonomy
    'taxonomy:tags',

    # Roles
    'user_role:administrator']

  # Permissions
  permissions = [
    'user_permission:view advanced help topic',
    'user_permission:view advanced help popup',
    'user_permission:view advanced help index',
    'user_permission:access backup and migrate',
    'user_permission:perform backup',
    'user_permission:access backup files',
    'user_permission:delete backup files',
    'user_permission:restore from backup',
    'user_permission:administer backup and migrate',
    'user_permission:show format tips',
    'user_permission:show more format tips link',
    'user_permission:show format selection for node',
    'user_permission:show format selection for taxonomy_term',
    'user_permission:show format selection for file',
    'user_permission:show format selection for user',
    'user_permission:administer blocks',
    'user_permission:access contextual links',
    'user_permission:administer delta blocks',
    'user_permission:administer delta',
    'user_permission:admin_view_modes',
    'user_permission:admin_fields',
    'user_permission:admin_classes',
    'user_permission:admin_display_suite',
    'user_permission:administer features',
    'user_permission:manage features',
    'user_permission:administer filters',
    'user_permission:use text format full_html_no_filters',
    'user_permission:use text format filtered_html',
    'user_permission:use text format full_html',
    'user_permission:use text format ds_code',
    'user_permission:administer image styles',
    'user_permission:administer media',
    'user_permission:import media',
    'user_permission:view media',
    'user_permission:edit media',
    'user_permission:add media from remote sources',
    'user_permission:administer menu',
    'user_permission:bypass node access',
    'user_permission:administer content types',
    'user_permission:administer nodes',
    'user_permission:access content overview',
    'user_permission:access content',
    'user_permission:view own unpublished content',
    'user_permission:view revisions',
    'user_permission:revert revisions',
    'user_permission:delete revisions',
    'user_permission:create page content',
    'user_permission:edit own page content',
    'user_permission:edit any page content',
    'user_permission:delete own page content',
    'user_permission:delete any page content',
    'user_permission:administer url aliases',
    'user_permission:create url aliases',
    'user_permission:administer pathauto',
    'user_permission:notify of path changes',
    'user_permission:administer redirects',
    'user_permission:administer search',
    'user_permission:search content',
    'user_permission:use advanced search',
    'user_permission:administer modernizr',
    'user_permission:administer shortcuts',
    'user_permission:customize shortcut links',
    'user_permission:switch shortcut sets',
    'user_permission:administer modules',
    'user_permission:administer site configuration',
    'user_permission:administer themes',
    'user_permission:administer software updates',
    'user_permission:administer actions',
    'user_permission:access administration pages',
    'user_permission:access site in maintenance mode',
    'user_permission:view the administration theme',
    'user_permission:access site reports',
    'user_permission:block IP addresses',
    'user_permission:administer taxonomy',
    'user_permission:edit terms in 1',
    'user_permission:delete terms in 1',
    'user_permission:access toolbar',
    'user_permission:administer permissions',
    'user_permission:administer users',
    'user_permission:access user profiles',
    'user_permission:change own username',
    'user_permission:cancel account',
    'user_permission:select account cancellation method',
    'user_permission:administer views',
    'user_permission:access all views',
    'user_permission:administer xmlsitemap']

  feature_name = "#{ PROJECT_NAME }_general"
  si_command= "drush fe #{ feature_name } " + components.join(' ') + " " + permissions.map { |i| "'" + i.to_s + "'" }.join(' ') + " --destination='sites/all/modules/custom' -y"

  FileUtils.cd "#{ PROJECT_NAME }/www"
  system %{ #{ si_command } }
  system %{ drush en #{ feature_name } -y }
  FileUtils.cd "../.."
end

def setup_git
  puts "Setting up git repo..."
  FileUtils.cd PROJECT_NAME
  system %{ git init; git add -A; git commit --quiet -m "Initial commit." }
  FileUtils.cd "www"
  system %{ drush dgb-backup --m="Initial database backup." }
  FileUtils.cd "../.."
  puts "Finished setting up git."
end

