namespace :quilted do

  task :init, [:project_name, :drush_makefile] => [:mktmp, "tmp/.gitignore", "tmp/drushrc.php"] do |t, args|
    desc "Setup default Quilted dgb file structure for Drupal projects."

    puts "Setting up file structure."
    dir = "tmp"
    
    puts "Installing Drupal."
    if not args.drush_makefile
      puts "Missing Drush makefile. Doing basic core install."
      system %{ cd tmp; drush dl drupal --drupal-project-rename="www"}
      system %{ cd .. }
    else
      system %{ drush make --prepare-install #{ args.drush_makefile } #{ dir }/www }
    end
    
    puts "Setting up drushrc.php symlink."
    File.symlink("../drushrc.php", "#{ dir }/www/drushrc.php")
    
    if args.project_name
      puts "Renaming project directory: #{ args.project_name }"
      File.rename(dir, args.project_name) 
      dir                                      = args.project_name
    end
    
    puts "Setting up git repo"
    Dir.chdir(dir)
    system %{ git init; git add -A; git commit -m "Initial commit" }
  end

  task :mktmp do |t|
      mkdir_p "tmp/databases"
  end

  file "tmp/.gitignore"                        => "tmp" do
    open("tmp/.gitignore", "w") do |file|
      file.puts "
www/sites/default/settings.php
www/sites/default/files/css/*
.DS_STORE
*.swp
*.swo"
    end
  end

  file "tmp/drushrc.php"                       => "tmp" do
    open("tmp/drushrc.php", "w") do |file|
      file.puts "<?php

$dgb_options                             = array(
'verbose'                                => FALSE,
// Necessary to have a better versionability of the sql dumps.
'ordered-dump'                           => TRUE,
// By default 'common' is a list of tables whose data will not be backed up.
// See below to change or add other keys can be added to
// $options['structure-tables'].
'structure-tables-key'                   => 'common',
// Useful to see what tables are effectively being backed up.
'display-dump-command'                   => TRUE,
// Path to the directory where the database dumps will be stored. Can be
// relative to DRUPAL_ROOT or absolute. Make sure it is within the git
// repository and outside the public web space of your server.
// Default is to assume the database dumps directory is one level up the
// drupal installation directory.
'dgb-dumps'                              => '../databases',
// Location of the git repository. Typically one level up DRUPAL_ROOT.
'dgb-repository'                         => '..',
// Setting a custom commit message.
'dgb-commit-message'                     => 'Auto-commit changes for databases',
);
$command_specific['dgb-dump']            = $dgb_options;
$command_specific['dgb-commit']          = $dgb_options;
$command_specific['dgb-usage']           = $dgb_options;
$command_specific['dgb-backup']          = $dgb_options;
      "
    end
  end

end
